<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="principal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" integrity="sha512-YWzhKL2whUzgiheMoBFwW8CKV4qpHQAEuvilg9FAn5VJUDwKZZxkJNuGM4XkWuk94WCrrwslk8yWNGmY1EduTA==" crossorigin="anonymous" />    
    <title> Área Principal </title>
    <script>
        if (localStorage.id == undefined) {
            alert("Login necessário!")
            window.location.href = "Login.html"
        }
    </script>
</head>

<body onLoad='hidden()'>
    <header>
        <div style="font-weight: bold; color: #fff;">
            <!-- <script> document.write(`Bem vindo, ${localStorage.nome}!`)</script> -->
            <p> Bem vindo, <span id="dynamic-name">name</span>!</p>
        </div>
        <div class="img-profile">
            <input type="checkbox" id="check-profile">
            <label for="check-profile">
                <img src="img/prof-fabio.png" alt="Profile">
            </label>
            <div>
                <ul id="profile-options">
                    <li onclick="" id=""> <i class="fas fa-user"></i> Perfil </li>
                    <li onclick="" id="" > <i class="fas fa-cog" ></i>  Configurações </li>
                    <li onclick="logout()" id="logout"> <i class="fas fa-power-off"></i> Sair </li>
                </ul>
            </div>
        </div>
    </header>
    <main>
        <section class="container">
            <div class="email">
                <p> <script> document.write(`Email: ${localStorage.email}`)</script> </p>
            </div>
            <div class="cargo">
                <p> <script> document.write(`Cargo: ${localStorage.cargo}`)</script> </p>
            </div>
            <div class="status">
                <p> <script> document.write(`Status: ${localStorage.status}`)</script> </p>
            </div>
            <div class="btn">
                <button type="button" onCLick="emitirProtocolo()" id="emitir-protocolo"> Emitir Protocolo </button>
                <button type="button" onCLick="cadastroSecretaria()" id="cadastro-secretaria"> Cadastrar Secretária </button>
                <button type="button" onCLick="showModal()" id="goto-bioterio"> Cadastrar Biotérios </button>
            </div>
        </section>
        <div class="content">
            <p>Tarefas:</p>
            <table border="1" id="tabela-atividades">
                <thead>
                    <th class="center">Tarefa</th>
                    <th class="center">Nome</th>
                    <th class="center">Status</th>
                    <th class="center">Link</th>
                </thead>
                <tbody id="tbody-atividades">
                </tbody>
            </table>
        </div>
        <div class="content">
            <p>Pesquisadores Cadastrados:</p>
            <table border="1" id="tabela-pesquisadores">
                <thead>
                    <th class="center">ID</th>
                    <th class="center">Nome</th>
                    <th class="center">email</th>
                    <th class="center">Cargo</th>
                    <th class="center">Status</th>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>

        <div id="wrapper-modal" class="">
            <label for="modal-checkbox" id="lbl-checkbox"><i class="fas fa-times-circle"></i></label>
            <input type="checkbox" id="modal-checkbox">
            <p>Nome: <h id = 'nome-bioterio'></p>
            <div>
                <p> Cadastrar nova espécie: </p>
                <input id = 'nome-especie' placeholder='Nome da espécie'>
            </div>
            <div>
                <button onClick = 'cadastrarEspecie()'><i class="fas fa-plus"></i> Cadastrar</button>
                <button onClick = 'excluirBioterio()'><i class="far fa-trash-alt"></i> Excluir Biotério</button>
            </div>
            <div class="content">
                <p>Espécies cadastradas:</p>
                <table border="1" id="tabela-especies">
                    <thead>
                        <th class="center">ID</th>
                        <th class="center">NOME</th>
                        <th class="center">delete</th>
                    </thead>
                    <tbody id="tbody-especies">
                    </tbody>
                </table>
            </div>
        </div>
    
    </main>
    <script>
        const nomeDinamico = document.getElementById('dynamic-name').innerHTML = localStorage.nome;
    </script>

    <script>
        function showModal(){
            modal = document.getElementById('wrapper-modal');
            checkbox = document.getElementById('modal-checkbox');
            modal.classList.add('active');
            
            document.addEventListener('click', ()=> {
                if(checkbox.checked){
                    modal.classList.remove('active');
                    checkbox.checked = false;
                }
                
            })

        }
    </script>
    <script>
        async function getEspecies() {
                var url = new URL(window.location.href);
                var id = url.searchParams.get("id");
                var list = []
                var especies = []
                let tbody = document.getElementById("tbody-especies")
                let bioterio = await fetch(`http://179.232.13.8:3333/Bioterio/${id}`, {
                    method: 'GET',
                })
                    .then((res) => res.json())
                    .then((data) => list.push(data))
                    .catch((err) => console.log(err));
                console.log(list[0].nome)
        
                document.getElementById("nome-bioterio").innerHTML = list[0].nome
                especies = list[0].especies.map((data) => {
                    return {
                        id: data.id,
                        nome: data.nome,
                        especies: data.qntEspecies
                    }
                })
                for (let i = 0; i < especies.length; i++) {
                    let tr = tbody.insertRow();
    
                        let td_id = tr.insertCell();
                        let td_nome = tr.insertCell();
                        let td_excluir = tr.insertCell();
                        
        
                        td_id.innerHTML = especies[i].id;
                        td_nome.innerText = especies[i].nome;
                        td_excluir.innerHTML = "<button onCLick='excluirEspecie(" + especies[i].id + ")'> X </button>";
                        console.log("sim")
                        
                }
        
                console.log(especies)
            }
    
        async function cadastrarEspecie(){
            var url = new URL(window.location.href);
            var id = url.searchParams.get("id");
            
            form = {
                "nome": document.getElementById("nome-especie").value,
            }
            await fetch(`http://179.232.13.8:3333/Bioterio/Especie/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json',
                      'Authorization': localStorage.cargo  },
            body: JSON.stringify(form),
          })
            .then((res) => res.json())
            .then((data) => user = data)
            .catch((err) => console.log(err));
    
            window.location.reload()
        }
        async function excluirBioterio(){
            var url = new URL(window.location.href);
            var id = url.searchParams.get("id");
            await fetch(`http://179.232.13.8:3333/Bioterio/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json',
                      'Authorization': localStorage.cargo  },
          })
            .then((res) => res.json())
            .then((data) => user = data)
            .catch((err) => console.log(err));
    
            window.location.href= '/Bioterio/List.html'
        }
        async function excluirEspecie(id){
            var url = new URL(window.location.href);
            var id_url = url.searchParams.get("id");
    
            await fetch(`http://179.232.13.8:3333/Bioterio/Especie/${id_url}/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json',
                      'Authorization': localStorage.cargo  },
          })
            .then((res) => res.json())
            .then((data) => user = data)
            .catch((err) => console.log(err));
            window.location.reload()
        }
    </script>
    <script>
        class pesquisadores {
            constructor() {
                this.pesquisadores = []
            }
        }
        function hidden() {
            if(localStorage.cargo != "admin" && localStorage.cargo != "secretaria"){
                document.getElementById("goto-bioterio").style.visibility = "hidden";
            }
            if (localStorage.cargo != "admin") {
                document.getElementById("cadastro-secretaria").style.visibility = "hidden";
            }
            if (localStorage.cargo == "secretaria") {
                document.getElementById("emitir-protocolo").style.visibility = "hidden";
            }
            getPesquisadores();
            getAtividades();
    
    
    
        }
        function logout() {
            localStorage.clear()
            window.location.href = "Login.html"
        }
        function emitirProtocolo() {
            window.location.href = "Emissao/Protocolo.html"
        }
        function cadastroSecretaria() {
            window.location.href = "Cadastro/Secretaria.html"
        }
        function gotoBioterio() {
            window.location.href = "Bioterio/List.html"
        }
        async function getPesquisadores() {
            var list = []
            var pesquisadores = []
            var presidentes = []
            let tbody = document.getElementById("tbody")
            let pesquisador = await fetch(`http://179.232.13.8:3333/Pesquisador/Lista`, {
                method: 'GET',
                headers: { 'Authorization': localStorage.cargo },
            })
                .then((res) => res.json())
                .then((data) => list.push(data))
                .catch((err) => console.log(err));
            console.log(list[0].pesquisadores)
    
    
            pesquisadores = list[0].pesquisadores.map((user) => {
                return {
                    id: user.id,
                    status: user.status,
                    cargo: user.role,
                    nome: user.nome,
                    email: user.email
                }
            })
            for (let i = 0; i < pesquisadores.length; i++) {
                let tr = tbody.insertRow();
                if (pesquisadores[i].status != "invalido") {
                    let td_id = tr.insertCell();
                    let td_nome = tr.insertCell();
                    let td_email = tr.insertCell();
                    let td_cargo = tr.insertCell();
                    let td_status = tr.insertCell();
    
                    td_id.innerHTML = "<a href='Pesquisador.html?id=" + pesquisadores[i].id + "'>" + pesquisadores[i].id; +"</a>";
                    td_nome.innerText = pesquisadores[i].nome;
                    td_email.innerText = pesquisadores[i].email;
                    td_cargo.innerText = pesquisadores[i].cargo;
                    td_status.innerText = pesquisadores[i].status;
                    console.log("sim")
    
                }
            }
    
            console.log(pesquisadores)
        }
        async function getAtividades() {
            if (localStorage.cargo == "secretaria" || localStorage.cargo == "admin") {
                let tbody2 = document.getElementById("tbody-atividades")
                let listAtividadesPesquisadores = []
                var listaSecretaria = []
                await fetch(`http://179.232.13.8:3333/Secretaria/Atividades`, {
                    method: 'GET',
                    headers: { 'Authorization': localStorage.cargo },
                })
                    .then((res) => res.json())
                    .then((data) => listAtividadesPesquisadores.push(data))
                    .catch((err) => console.log(err));
    
                listaSecretaria = listAtividadesPesquisadores[0].pesquisadores.map((user) => {
                    return {
                        id: user.id,
                        status: user.status,
                        cargo: user.role,
                        nome: user.nome,
                        email: user.email
                    }
                })
    
                for (let i = 0; i < listaSecretaria.length; i++) {
                    if (listaSecretaria[i].id != "1") {
                        let tr = tbody2.insertRow();
                        let td_tarefa = tr.insertCell();
                        let td_nome = tr.insertCell();
                        let td_status = tr.insertCell();
                        let td_link = tr.insertCell();
    
    
    
                        td_tarefa.innerHTML = "<a href='Pesquisador.html?id=" + listaSecretaria[i].id + "'>" + "Validar cadastro" + "</a>";
                        td_link.innerHTML = "<a href='Pesquisador.html?id=" + listaSecretaria[i].id + "'>" + listaSecretaria[i].email; +"</a>";
                        td_nome.innerText = listaSecretaria[i].nome;
                        td_status.innerText = listaSecretaria[i].status;
                        console.log("sim")
                    }
    
                }
    
            }
    
        }
    
    </script>
</body>
</html>